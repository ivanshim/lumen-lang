#!/bin/bash

# Test runner for lumen-lang examples
# Tests each example file with both stream and microcode kernels

BINARY="./target/debug/lumen-lang"
VERBOSE=false
PASSED=0
FAILED=0
SKIPPED=0

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Parse arguments
if [[ "$1" == "--verbose" ]]; then
    VERBOSE=true
fi

# Build the project first
echo -e "${BLUE}Building lumen-lang...${NC}"
cargo build --quiet 2>/dev/null || {
    echo -e "${RED}Build failed!${NC}"
    exit 1
}

echo -e "${BLUE}Built successfully${NC}\n"

# Function to run a test
run_test() {
    local file=$1
    local kernel=$2
    local filename=$(basename "$file")

    if timeout 5 $BINARY --kernel "$kernel" "$file" > /tmp/test_out.txt 2>&1; then
        echo -e "${GREEN}PASS${NC} $filename ($kernel)"
        ((PASSED++))
        if [[ "$VERBOSE" == "true" ]]; then
            echo "  Output:"
            sed 's/^/    /' /tmp/test_out.txt | head -10
        fi
        return 0
    else
        return 1
    fi
}

# Test lumen examples
echo -e "${BLUE}=== Testing Lumen Examples ===${NC}"
for file in examples/lumen/*.lm; do
    filename=$(basename "$file")

    # Skip extern examples for now (they require external dependencies)
    if [[ $filename == extern_* ]]; then
        echo -e "${YELLOW}SKIP${NC} $filename (external dependencies)"
        ((SKIPPED++))
        continue
    fi

    # Test with stream kernel
    if run_test "$file" "stream"; then
        :
    else
        echo -e "${RED}FAIL${NC} $filename (stream)"
        ((FAILED++))
        if [[ "$VERBOSE" == "true" ]]; then
            tail -3 /tmp/test_out.txt | sed 's/^/    /'
        fi
    fi

    # Test with microcode kernel
    if run_test "$file" "microcode"; then
        :
    else
        echo -e "${YELLOW}SKIP${NC} $filename (microcode - not fully implemented)"
        ((SKIPPED++))
    fi
done

# Test mini_python examples
echo -e "\n${BLUE}=== Testing Mini-Python Examples ===${NC}"
for file in examples/mini_python/*.py; do
    filename=$(basename "$file")

    # Test with stream kernel
    if run_test "$file" "stream"; then
        :
    else
        echo -e "${RED}FAIL${NC} $filename (stream)"
        ((FAILED++))
        if [[ "$VERBOSE" == "true" ]]; then
            tail -3 /tmp/test_out.txt | sed 's/^/    /'
        fi
    fi

    # Microcode kernel not yet implemented for mini-python
    echo -e "${YELLOW}SKIP${NC} $filename (microcode - not implemented)"
    ((SKIPPED++))
done

# Test mini_rust examples
echo -e "\n${BLUE}=== Testing Mini-Rust Examples ===${NC}"
for file in examples/mini_rust/*.rs; do
    filename=$(basename "$file")

    # Test with stream kernel
    if run_test "$file" "stream"; then
        :
    else
        echo -e "${RED}FAIL${NC} $filename (stream)"
        ((FAILED++))
        if [[ "$VERBOSE" == "true" ]]; then
            tail -3 /tmp/test_out.txt | sed 's/^/    /'
        fi
    fi

    # Microcode kernel not yet implemented for mini-rust
    echo -e "${YELLOW}SKIP${NC} $filename (microcode - not implemented)"
    ((SKIPPED++))
done

# Summary
echo -e "\n${BLUE}=== Test Summary ===${NC}"
echo -e "Passed:  ${GREEN}$PASSED${NC}"
echo -e "Failed:  ${RED}$FAILED${NC}"
echo -e "Skipped: ${YELLOW}$SKIPPED${NC}"
echo -e "Total:   $((PASSED + FAILED + SKIPPED))"

# Exit with appropriate code
if [[ $FAILED -gt 0 ]]; then
    exit 1
else
    exit 0
fi
